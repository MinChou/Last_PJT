{% load bootstrap4 %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
  <div id="app">
  <div class="container">
  <div class="card text-center mx-auto" style="width: 45rem;">
    <div class="card-header">
      <img src="{{movie.poster_url}}" alt="movie_poster" style="height:500px;"><hr>
      <h3>{{movie.title}}</h3>
    </div>
    <div class="card-body">
      <h5 class="card-title d-inline">장르 :</h5> 
      {% for genre in movie.genres.all  %}
        <h5 class="card-title d-inline">'{{genre}}' </h5>
      {% endfor %}
      <h5 class="card-title mt-1">관객 : {{movie.audience}}</h5>
      <h5 class="card-title"></h5>
      <p class="card-text">{{ movie.description }}</p>
    </div>
    <div class="card-footer text-muted">
    </div>
  </div>

    {% if request.user.is_authenticated %}
        <label for="comment">리뷰</label>
        <input type="text" name="" id="comment" value="">
        <label for="score">점수</label>
        <input type="number" name="" id="score" value="">
        <a class="btn btn-primary create_rating" href="#" data-id={{movie.pk}}>평점 남기기</a>
      </form>
    {% else %}
      <br>
    <div style="text-align: center;">
      <a href="{% url 'accounts:login' %}"><b>평점을 남기려면 로그인해주세요.</b> </a>
    </div>
    {% endif %}
    <br><br>
    리뷰 목록 <span >{{movie.ratings_set.count}}</span>개의 rating
    {% for rating in ratings %}
      {{rating.user}} / {{rating.comment}}
      <button class="btn btn-danger delete_rating">리뷰 삭제</button>
    {% endfor %}
    </div>
  </div>


  <script src="https://kit.fontawesome.com/caed28bd65.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const sendRating = document.querySelector('.create_rating')
    const my_comment = document.querySelector('#comment')
    const my_score = document.querySelector('#score')
    sendRating.onclick = function(event){
      const movieId = event.target.dataset.id
      console.log(my_comment.value)
      console.log(my_score.value)
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.post(`http://127.0.0.1:8000/movies/rating_create/${movieId}/`, {
        comment : my_comment.value,
        score: my_score.value
        }).then( response => {
          console.log(response)
        }).catch( error => {
          console.log(error)
      })
    }
  </script>
</body>
</html>

  

