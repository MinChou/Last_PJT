{% load bootstrap4 %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/0638859061.js" crossorigin="anonymous"></script>
</head>
<body>
  {{request.user}}
  <div id="app">
  <div class="container">
  <div class="card text-center mx-auto" style="width: 45rem;">
    <div class="card-header">
      <img src="{{movie.poster_url}}" alt="movie_poster" style="height:500px;"><hr>
      <h3>{{movie.title}}</h3>
    </div>
    <div class="card-body">
      <h5 class="card-title d-inline">장르 :</h5> 
      {% for genre in movie.genres.all  %}
        <h5 class="card-title d-inline">'{{genre}}' </h5>
      {% endfor %}
      <h5 class="card-title mt-1">관객 : {{movie.audience}}</h5>
      <h5 class="card-title"></h5>
      <p class="card-text">{{ movie.summary }}</p>
      <br>
       {% if user in movie.like_users.all %}          
        <i class="fas fa-heart-broken like-button" style="color: black;" data-id="{{ movie.pk }}">싫은데요</i> 
       {% else %}         
        <i class="fas fa-heart like-button" style="color: crimson;" data-id="{{ movie.pk }}">좋아요</i>      
       {% endif %}
       <span class="" style="" id="like-count-{{ movie.pk }}">이 영화를 좋아하는 사람 : {{ movie.like_users.count }}명</span>
    </div>
    <div class="card-footer">
      {% if request.user.username == "admin" %}
        <a href="{% url 'movies:movie_modify' movie.pk %}" class="btn btn-success">영화 수정</a>
        <form action="" style="display:inline;">
          <input type="submit" href="#" class="btn btn-warning movie-delete" value="영화 삭제">
        </form>
      {% endif %}
    </div>
  </div>

    {% if request.user.is_authenticated %}
        {% comment %} <label for="comment">리뷰</label>
        <input type="text" name="" id="comment" value="">
        <label for="score">점수</label>
        <input type="number" name="" id="score" value="">
        <a class="btn btn-primary create_rating" data-id={{movie.pk}}>평점 남기기</a> {% endcomment %}
      <form action="{% url 'movies:rating_create' movie.pk %}" method="POST" id="createForm">
        {% bootstrap_form form %}{% csrf_token %}
        <button style="submit" class="btn btn-primary">submit!</button>
      </form>

    {% else %}
      <br>
    <div style="text-align: center;">
      <a href="{% url 'accounts:login' %}"><b>평점을 남기려면 로그인해주세요.</b> </a>
    </div>
    {% endif %}
    <br><br>
    리뷰 목록 <span >{{ratings | length}}</span>개의 rating
    <ul class="list-group">
      {% for rating in ratings %}
        <div id="">
          <div class="{{rating.id}} ratingForm">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="{% url 'accounts:user_detail' rating.user.pk %}">{{rating.user}}</a> {{rating.comment}}
              <div>
                <span class="badge badge-primary badge-pill">{{rating.score}}점</span>
                {% if rating.user == request.user %}
                  <a href="#" class="badge badge-success modify-btn" data-id="{{rating.id}}" onclick="return false;">수정</a>
                  <form action="" style="display:inline;" method="POST">
                    <a href="#" class="badge badge-danger rating-delete">삭제</a>
                  </form>
                  {% comment %} <a class="btn btn-danger" href="{% url 'movies:rating_delete' movie.pk rating.pk %}">리뷰 삭제</a> {% endcomment %}
                {% endif %}
              </div>
            </li>
          </div>
          <li class="{{rating.pk}} modifyForm" style="display:none;" class="list-group-item">
            <form action="{% url 'movies:rating_modify' movie.pk rating.pk %}" method="POST">
              {% csrf_token %}              
              <div class="form-row">
                <div class="">
                  <input type="number" name="score" class="form-control" placeholder="First name" style="width:100px;" value="{{rating.score}}">
                </div>
                <div class="col">
                  <input type="text" name="comment" class="form-control" placeholder="Last name" style="width: 100%;" value="{{rating.comment}}">
                </div>
                <button style="submit" class="badge badge-success">수정</a>
                <button class="badge badge-danger modify-cancel">수정 취소</a>
              </div>
            </form>
          </li>
      </div>
      {% endfor %}
    </ul>
    

    </div>
  </div>
  <script type="text/javascript">
    const modifyForms = document.querySelectorAll('.modifyForm')
    const ratingForms = document.querySelectorAll('.ratingForm')
    console.log(ratingForms)
    const modifyBtns = document.querySelectorAll('.modify-btn')
    const modifyCancel = document.querySelectorAll('.modify-cancel')
    for (let i = 0; i < ratingForms.length; i++){
      modifyBtns[i].onclick = function(){
        for (let j = 0; j < ratingForms.length; j++){
          modifyForms[j].style.display = 'none'
          ratingForms[j].style.display = 'block'
        }
      modifyForms[i].style.display = 'block'
      ratingForms[i].style.display = 'none'
      return false
      }
      modifyCancel[i].onclick = function(){
        modifyForms[i].style.display = 'none'
        ratingForms[i].style.display = 'block'
        return false
      }
    }

     const likeButtons = document.querySelectorAll('.like-button')   
     likeButtons.forEach(button => {     
       button.addEventListener('click', function(event) {       
         const articleId = event.target.dataset.id       
         axios.defaults.xsrfCookieName = 'csrftoken'       
         axios.defaults.xsrfHeaderName = 'X-CSRFToken'
  </script>

  {% comment %} <script src="https://kit.fontawesome.com/caed28bd65.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
  <script>
    const app = new Vue({
      el : '#app',
      data: {
        ratingList : [],
      },
      computed: {
        computedRatingList: function(){
          this.$session.start()
          const computedRatings = this.$session.get('ratinsg')
          return computedRatings
        }
      } 
    })

    const sendRating = document.querySelector('.create_rating')
    const my_comment = document.querySelector('#comment')
    const my_score = document.querySelector('#score')

    sendRating.onclick = function(event){
      const movieId = event.target.dataset.id
      console.log(my_comment.value)
      console.log(my_score.value)
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
      const csrftoken = Cookies.get('csrftoken');
      axios({
        method: 'POST',
        url: `http://127.0.0.1:8000/movies/rating_create/${movieId}/`,
        headers: {
            'X-CSRFToken': csrftoken,
          },
        data: {
          comment: my_comment.value,
          score : my_score.value
        }
      });
    }
  </script> {% endcomment %}
</body>
</html>

  

